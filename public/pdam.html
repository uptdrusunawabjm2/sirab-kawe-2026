<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>PDAM - Data Meter</title>
<script src="https://cdn.tailwindcss.com"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ================================
   MOBILE RESPONSIVE TAMBAHAN
   Tidak mengubah struktur utama
================================ */

/* Sembunyikan filter bulan di mobile */
@media (max-width: 768px){
  #filterBulan{
    display:none !important;
  }
}

/* Input kamar otomatis huruf besar */
#filterKamar{
  text-transform: uppercase;
}

/* ================================
   MODE TABEL PADAT KHUSUS MOBILE
   Tidak mengubah struktur HTML
================================ */
@media (max-width: 768px){

  /* Font lebih kecil */
  table{
    font-size:12px !important;
  }

  /* Tinggi baris dipadatkan */
  th, td{
    padding:6px 8px !important;
  }

  /* Header lebih rapat */
  thead th{
    padding:7px 8px !important;
    font-size:11px !important;
  }

  /* Hilangkan whitespace agar tidak melebar */
  td, th{
    white-space:nowrap;
  }

  /* Kolom foto diperkecil */
  td:last-child, th:last-child{
    width:50px;
  }

  /* Link foto diperkecil */
  td a{
    padding:2px 4px !important;
    font-size:11px !important;
  }

  /* Info pagination lebih kecil */
  #info{
    font-size:10px;
  }

  /* Tombol pagination lebih kecil */
  .flex.gap-2 button{
    padding:3px 6px !important;
    font-size:11px !important;
  }
}
</style>
</head>

<body class="bg-slate-950 text-slate-200 p-4 md:p-6">

<h1 class="text-lg md:text-xl font-semibold mb-4 flex items-center gap-2 text-slate-100">
  ðŸ“Š <span>Data Meter PDAM</span>
</h1>

<!-- FILTER -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
  <select id="filterRusun" class="bg-slate-900 border border-slate-800 p-2.5 rounded-lg text-sm">
    <option value="">Semua Rusunawa</option>
  </select>

  <input id="filterKamar" placeholder="Cari No Kamar (ex: C3.01)"
    class="bg-slate-900 border border-slate-800 p-2.5 rounded-lg text-sm">

  <input type="month" id="filterBulan"
    class="bg-slate-900 border border-slate-800 p-2.5 rounded-lg text-sm">

  <div class="flex gap-2">
    <button onclick="applyFilter()"
      class="flex-1 bg-blue-600/80 hover:bg-blue-600 px-4 py-2.5 rounded-lg text-sm font-medium">
      Terapkan
    </button>
    <button onclick="resetFilter()"
      class="flex-1 bg-slate-800 hover:bg-slate-700 px-4 py-2.5 rounded-lg text-sm">
      Reset
    </button>
  </div>
</div>

<!-- TABLE -->
<div class="overflow-auto bg-slate-900 border border-slate-800 rounded-xl">
<table class="w-full text-sm md:text-[13px]">
<thead class="sticky top-0 z-10 bg-slate-900/95 backdrop-blur border-b border-slate-800">
<tr class="text-slate-400">
  <th class="px-3 py-3 text-left font-medium">Rusunawa</th>
  <th class="px-3 py-3 text-left font-medium">No Kamar</th>
  <th class="px-3 py-3 text-left font-medium">Tanggal</th>
  <th class="px-3 py-3 text-right font-medium">Angka</th>
  <th class="px-3 py-3 text-right font-medium">Selisih</th>
  <th class="px-3 py-3 text-center font-medium">Foto</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- PAGINATION -->
<div class="flex justify-between items-center mt-3 text-xs text-slate-400">
  <div id="info"></div>
  <div class="flex gap-2">
    <button onclick="prevPage()" class="px-3 py-1.5 bg-slate-800 rounded hover:bg-slate-700">Prev</button>
    <button onclick="nextPage()" class="px-3 py-1.5 bg-slate-800 rounded hover:bg-slate-700">Next</button>
  </div>
</div>

<script>
let allData = [];
let filteredData = [];
let page = 1;
const limit = 50;
const EXTREME_LIMIT = 25; // ambang selisih ekstrem

function driveToView(url){
  if(!url) return "";
  const m = url.match(/id=([^&]+)/);
  return m ? "https://drive.google.com/file/d/"+m[1]+"/view" : url;
}

async function loadPDAM(){
  const r = await fetch("/api/pdam?action=table");
  const j = await r.json();
  if(!j.status) return;

  allData = (j.data || []).sort(
    (a,b)=> new Date(b.tanggal) - new Date(a.tanggal)
  );
  filteredData = allData;

  populateRusunFilter(allData);
  render();
}

function populateRusunFilter(data){
  const set = new Set(data.map(d=>d.rusunawa).filter(Boolean));
  set.forEach(r=>{
    filterRusun.innerHTML += `<option>${r}</option>`;
  });
}

function applyFilter(){
  const rusun = filterRusun.value;
  const kamar = filterKamar.value.toLowerCase();
  const bulan = filterBulan.value;

  filteredData = allData.filter(d=>{
    if(rusun && d.rusunawa !== rusun) return false;
    if(kamar && !String(d.no_kamar).toLowerCase().includes(kamar)) return false;
    if(bulan){
      const dt = new Date(d.tanggal);
      const ym = dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0");
      if(ym !== bulan) return false;
    }
    return true;
  });

  page = 1;
  render();
}

function resetFilter(){
  filterRusun.value="";
  filterKamar.value="";
  filterBulan.value="";
  filteredData = allData;
  page = 1;
  render();
}

function render(){
  tbody.innerHTML="";
  const start = (page-1)*limit;
  const slice = filteredData.slice(start,start+limit);

  slice.forEach((d,i)=>{
    const zebra = i%2 ? "bg-slate-900" : "bg-slate-950";
    const fotoLink = d.foto ? driveToView(d.foto) : "";

    let selisihClass = "text-slate-500";
let selisihBadge = "";

if (d.selisih_meter <= 1 || d.selisih_meter > 25) {
  // EXTREME
  selisihClass = "text-amber-400 font-semibold";
  selisihBadge = `<span class="ml-1 text-amber-400"></span>`;
} else {
  // NORMAL
  selisihClass = "text-green-400/80";
}


    tbody.innerHTML += `
    <tr class="${zebra} hover:bg-slate-800/60 border-b border-slate-800/60">
      <td class="px-3 py-3 text-slate-300 whitespace-nowrap">${d.rusunawa}</td>
      <td class="px-3 py-3 font-medium text-blue-400 whitespace-nowrap">${d.no_kamar}</td>
      <td class="px-3 py-3 text-slate-400 whitespace-nowrap">${new Date(d.tanggal).toLocaleDateString("id-ID")}</td>
      <td class="px-3 py-3 text-right tracking-wide">${d.angka_meter}</td>
      <td class="px-3 py-3 text-right ${selisihClass}">
        ${d.selisih_meter}${selisihBadge}
      </td>
      <td class="px-3 py-3 text-center">
        ${fotoLink
          ? `<a href="${fotoLink}" target="_blank"
               class="text-blue-400/80 hover:text-blue-400 underline px-2 py-1 inline-block">
               lihat
             </a>`
          : "-"}
      </td>
    </tr>`;
  });

  info.innerText =
    `Menampilkan ${start+1}-${Math.min(start+limit, filteredData.length)} dari ${filteredData.length}`;
}

function nextPage(){ if(page*limit < filteredData.length){ page++; render(); } }
function prevPage(){ if(page>1){ page--; render(); } }

loadPDAM();

/* ================================
   AUTO UPPERCASE INPUT KAMAR
================================ */
filterKamar.addEventListener("input", function(){
  this.value = this.value.toUpperCase();
});
</script>

</body>
</html>


