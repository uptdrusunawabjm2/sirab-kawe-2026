<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>PDAM - Data Meter</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 p-8">

<h1 class="text-2xl font-bold mb-6">ðŸ“Š Data Meter PDAM</h1>

<!-- FILTER -->
<div class="flex flex-wrap gap-3 mb-5">
  <select id="filterRusun" class="bg-slate-900 border border-slate-700 p-2 rounded-lg text-sm">
    <option value="">Semua Rusunawa</option>
  </select>

  <input type="month" id="filterBulan" class="bg-slate-900 border border-slate-700 p-2 rounded-lg text-sm">

  <button onclick="applyFilter()" class="bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold">Terapkan</button>
  <button onclick="resetFilter()" class="bg-slate-800 px-4 py-2 rounded-lg text-sm">Reset</button>
</div>

<!-- TABLE -->
<div class="overflow-auto bg-slate-900 border border-slate-800 rounded-2xl p-4">
<table class="w-full text-sm">
<thead class="border-b border-slate-700 text-slate-300">
<tr>
  <th>Rusunawa</th>
  <th>No Kamar</th>
  <th>Tanggal</th>
  <th class="text-right">Angka Meter</th>
  <th class="text-right">Selisih</th>
  <th class="text-center">Foto</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- PAGINATION -->
<div class="flex justify-between items-center mt-4 text-sm">
  <div id="info"></div>
  <div class="flex gap-2">
    <button onclick="prevPage()" class="px-3 py-1 bg-slate-800 rounded">Prev</button>
    <button onclick="nextPage()" class="px-3 py-1 bg-slate-800 rounded">Next</button>
  </div>
</div>

<!-- MODAL FOTO -->
<div id="fotoModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
  <div class="bg-slate-900 rounded-xl p-4">
    <button onclick="closeFoto()" class="text-red-400 mb-2">âœ– Tutup</button>
    <img id="fotoImg" class="max-h-[80vh] rounded">
  </div>
</div>

<script>
let allData = [];
let filteredData = [];
let page = 1;
const limit = 50;

async function loadPDAM(){
  const r = await fetch("/api/pdam?action=table");
  const j = await r.json();
  if(!j.status) return;

  allData = j.data || [];
  filteredData = allData;

  populateRusunFilter(allData);
  render();
}

function populateRusunFilter(data){
  const set = new Set(data.map(d=>d.rusunawa).filter(Boolean));
  set.forEach(r=>{
    filterRusun.innerHTML += `<option>${r}</option>`;
  });
}

function applyFilter(){
  const r = filterRusun.value;
  const b = filterBulan.value;

  filteredData = allData.filter(d=>{
    let ok = true;
    if(r && d.rusunawa !== r) ok = false;
    if(b){
      const dt = new Date(d.tanggal);
      const ym = dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0");
      if(ym !== b) ok = false;
    }
    return ok;
  });

  page = 1;
  render();
}

function resetFilter(){
  filterRusun.value="";
  filterBulan.value="";
  filteredData = allData;
  page = 1;
  render();
}

function render(){
  tbody.innerHTML="";
  const start = (page-1)*limit;
  const slice = filteredData.slice(start, start+limit);

  slice.forEach(d=>{
    tbody.innerHTML += `
    <tr class="border-b border-slate-800">
      <td>${d.rusunawa}</td>
      <td class="font-bold text-blue-400">${d.no_kamar}</td>
      <td>${new Date(d.tanggal).toLocaleDateString("id-ID")}</td>
      <td class="text-right">${d.angka_meter}</td>
      <td class="text-right text-green-400 font-bold">${d.selisih_meter}</td>
      <td class="text-center">
        ${d.foto ? `<button onclick="openFoto('${d.foto}')" class="underline text-blue-400">lihat</button>`:"-"}
      </td>
    </tr>`;
  });

  info.innerText = `Menampilkan ${start+1}-${Math.min(start+limit, filteredData.length)} dari ${filteredData.length}`;
}

function nextPage(){
  if(page*limit < filteredData.length){ page++; render(); }
}
function prevPage(){
  if(page>1){ page--; render(); }
}

function openFoto(u){
  fotoImg.src=u;
  fotoModal.classList.remove("hidden");
  fotoModal.classList.add("flex");
}
function closeFoto(){
  fotoModal.classList.add("hidden");
  fotoImg.src="";
}

loadPDAM();
</script>

</body>
</html>
