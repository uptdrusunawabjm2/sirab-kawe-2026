<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Rusunawa</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-950 text-gray-100 min-h-screen">

<div class="max-w-7xl mx-auto p-6">

<h1 class="text-3xl font-bold mb-8 flex items-center gap-2">
  Rusunawa Kota Banjarmasin
</h1>

<!-- DASHBOARD UTAMA -->
<div id="cards" class="grid grid-cols-1 md:grid-cols-5 gap-5 mb-12"></div>

<!-- DASHBOARD PER RUSUN -->
<h2 class="text-xl font-bold mb-4 flex items-center gap-2">Dashboard Rusunawa</h2>
<div id="perRusun" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>

<p id="lastUpdate" class="text-gray-400 text-sm mt-10"></p>

</div>

<script>
async function load(){
  const r = await fetch('/api/data?action=public');
  const j = await r.json();
  const d = j.data;

  /* =====================
     GLOBAL
  ===================== */
  const persenGlobal = d.totalUnit 
    ? ((d.unitTerisi / d.totalUnit) * 100).toFixed(1) 
    : 0;

  cards.innerHTML = `
    ${card("Total Unit", d.totalUnit, "from-slate-700 to-slate-800")}
    ${card("Siap Huni", d.unitSiapHuni, "from-green-600 to-green-700")}
    ${card("Terisi", d.unitTerisi, "from-blue-600 to-blue-700")}
    ${card("Rusak", d.unitRusak, "from-red-600 to-red-700")}
    ${card("Hunian", persenGlobal + " %", "from-purple-600 to-purple-700")}
  `;

  /* =====================
     PER RUSUN (UI BAGUS)
  ===================== */
  renderPerRusun(d);

  lastUpdate.innerText = "Update terakhir: " + new Date().toLocaleString("id-ID");
}

function renderPerRusun(d){
  let html = "";

  Object.keys(d.struktur).forEach(rusun=>{
    let terisi = 0;
    Object.values(d.struktur[rusun]).forEach(v=>{
      terisi += Number(v||0);
    });

    // proporsi dari total (estimasi adil karena semua dari Sheet1)
    const rasio = d.unitTerisi ? terisi / d.unitTerisi : 0;

    const total = Math.round(d.totalUnit * rasio);
    const siap  = Math.round(d.unitSiapHuni * rasio);
    const rusak = Math.round(d.unitRusak * rasio);

    const persen = total ? ((terisi/total)*100).toFixed(1) : 0;

    html += `
    <div class="bg-gradient-to-br from-gray-900 to-gray-800 p-6 rounded-2xl shadow-xl border border-gray-800">
      <h3 class="text-lg font-bold mb-4">${rusun}</h3>
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>Total Unit</div><div class="text-right font-bold">${total}</div>
        <div>Terisi</div><div class="text-right text-blue-400 font-bold">${terisi}</div>
        <div>Siap Huni</div><div class="text-right text-green-400 font-bold">${siap}</div>
        <div>Rusak</div><div class="text-right text-red-400 font-bold">${rusak}</div>
        <div>Hunian</div><div class="text-right text-purple-400 font-bold">${persen} %</div>
      </div>
    </div>`;
  });

  perRusun.innerHTML = html;
}

function card(title, value, gradient){
  return `
  <div class="bg-gradient-to-br ${gradient} p-7 rounded-2xl shadow-xl">
    <div class="text-sm opacity-80 mb-1">${title}</div>
    <div class="text-4xl font-bold tracking-wide">${value}</div>
  </div>`;
}

load();
setInterval(load, 60000);
</script>

</body>
</html>
