<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Dashboard Internal Rusun</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.badge {
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  display: inline-block;
}
.badge-terisi {
  background: rgba(34,197,94,.15);
  color: #22c55e;
  border: 1px solid rgba(34,197,94,.4);
}
.badge-rusak {
  background: rgba(239,68,68,.15);
  color: #ef4444;
  border: 1px solid rgba(239,68,68,.4);
}
.badge-siap {
  background: rgba(234,179,8,.15);
  color: #eab308;
  border: 1px solid rgba(234,179,8,.4);
}
.pagination button {
  padding: 6px 12px;
  margin: 0 2px;
  border-radius: 8px;
  border: 1px solid #334155;
  background: #020617;
  color: white;
  cursor: pointer;
}
.pagination button.active {
  background: #2563eb;
  border-color: #2563eb;
}
.pagination button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
</style>
</head>

<body class="bg-slate-950 text-white">

<div class="flex">

<!-- SIDEBAR -->
<div class="w-64 bg-slate-900 min-h-screen p-5">
  <h1 class="text-xl font-bold mb-6">üè† RUSUN DASHBOARD</h1>
  <div class="text-slate-300 mb-2">Manajemen Penghuni</div>
  <a href="/login.html" class="text-red-400 mt-10 inline-block">Logout</a>
</div>

<!-- MAIN -->
<div class="flex-1 p-8">
  <h2 class="text-2xl font-bold mb-6">Dashboard Internal</h2>

  <!-- CARD -->
  <div class="grid grid-cols-4 gap-4 mb-8">
    <div class="bg-slate-800 p-4 rounded">Penghuni<br><b id="penghuni">-</b></div>
    <div class="bg-slate-800 p-4 rounded">Unit Terisi<br><b id="unitTerisi">-</b></div>
    <div class="bg-slate-800 p-4 rounded">Total Bayar<br><b id="totalBayar">Rp 0</b></div>
    <div class="bg-slate-800 p-4 rounded">Total Tunggakan<br><b id="totalTunggakan">Rp 0</b></div>
  </div>

  <!-- TABLE -->
  <div class="bg-slate-900 rounded p-5">
    <h3 class="font-bold mb-4">Daftar Penghuni</h3>

    <div class="flex gap-3 mb-4">
      <input id="searchInput" placeholder="Cari unit / nama..." class="flex-1 p-2 bg-slate-800 rounded">
      <select id="statusFilter" class="p-2 bg-slate-800 rounded">
        <option value="">Semua Status</option>
        <option value="TERISI">Terisi</option>
        <option value="RUSAK">Rusak</option>
        <option value="SIAP">Siap Huni</option>
      </select>
    </div>

    <table class="w-full text-sm">
      <thead class="border-b border-slate-700">
        <tr>
          <th class="py-2 text-left">Unit</th>
          <th class="py-2 text-left">Nama</th>
          <th class="py-2 text-left">Status</th>
          <th class="py-2 text-left">Total Bayar</th>
          <th class="py-2 text-left">Total Tunggakan</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div id="pagination" class="pagination mt-4"></div>
  </div>
</div>
</div>

<script>
const penghuni = document.getElementById("penghuni");
const unitTerisi = document.getElementById("unitTerisi");
const totalBayar = document.getElementById("totalBayar");
const totalTunggakan = document.getElementById("totalTunggakan");
const tbody = document.getElementById("tbody");

const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");
const pagination = document.getElementById("pagination");

let allData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 25;

async function loadData(){
  const res = await fetch("/api/data?action=internal&key=rusun2026");
  const json = await res.json();

  const sum = json.data.summary;
  const data = json.data.data;

  penghuni.innerText = sum.penghuni;
  unitTerisi.innerText = sum.terisi;
  totalBayar.innerText = "Rp " + Number(sum.totalBayar).toLocaleString("id-ID");
  totalTunggakan.innerText = "Rp " + Number(sum.totalTunggakan).toLocaleString("id-ID");

  allData = data;
  filteredData = data;
  renderTable();
}

function badgeStatus(status){
  if(!status) return "-";
  const s = status.toLowerCase();
  if(s.includes("terisi")) return `<span class="badge badge-terisi">Terisi</span>`;
  if(s.includes("rusak")) return `<span class="badge badge-rusak">Rusak</span>`;
  if(s.includes("siap")) return `<span class="badge badge-siap">Siap Huni</span>`;
  return status;
}

function applyFilter(){
  const search = searchInput.value.toLowerCase();
  const status = statusFilter.value;

  filteredData = allData.filter(d=>{
    const unit = (d.unit||"").toLowerCase();
    const nama = (d.nama||"").toLowerCase();
    const st = (d.kondisiunit||"").toUpperCase();

    const cocokSearch = unit.includes(search) || nama.includes(search);
    const cocokStatus = !status || st.includes(status);

    return cocokSearch && cocokStatus;
  });

  currentPage = 1;
  renderTable();
}

function renderTable(){
  tbody.innerHTML = "";

  const start = (currentPage-1)*rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start,end);

  pageData.forEach(d=>{
    tbody.innerHTML += `
      <tr class="border-b border-slate-800">
        <td class="py-1 uppercase">${d.unit||""}</td>
        <td>${d.nama||""}</td>
        <td>${badgeStatus(d.kondisiunit)}</td>
        <td>Rp ${Number(d.pembayaran||0).toLocaleString("id-ID")}</td>
        <td>Rp ${Number(d.tunggakan||0).toLocaleString("id-ID")}</td>
      </tr>
    `;
  });

  renderPagination();
}

function renderPagination(){
  pagination.innerHTML="";
  const totalPage = Math.ceil(filteredData.length / rowsPerPage);

  const prev = document.createElement("button");
  prev.textContent="Prev";
  prev.disabled = currentPage===1;
  prev.onclick=()=>{currentPage--;renderTable();};
  pagination.appendChild(prev);

  for(let i=1;i<=totalPage;i++){
    const b=document.createElement("button");
    b.textContent=i;
    if(i===currentPage) b.classList.add("active");
    b.onclick=()=>{currentPage=i;renderTable();};
    pagination.appendChild(b);
  }

  const next = document.createElement("button");
  next.textContent="Next";
  next.disabled = currentPage===totalPage;
  next.onclick=()=>{currentPage++;renderTable();};
  pagination.appendChild(next);
}

searchInput.addEventListener("input", applyFilter);
statusFilter.addEventListener("change", applyFilter);

loadData();
</script>
</body>
</html>
