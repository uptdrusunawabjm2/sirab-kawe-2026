<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Dashboard Internal Rusun</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
.badge-terisi{background:rgba(34,197,94,.15);color:#22c55e;border:1px solid rgba(34,197,94,.4)}
.badge-rusak{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.4)}
.badge-siap{background:rgba(234,179,8,.15);color:#eab308;border:1px solid rgba(234,179,8,.4)}
.menu-link{display:block;padding:8px 10px;border-radius:8px}
.menu-link:hover{background:#020617}
.pagination button{padding:6px 12px;margin:0 2px;border-radius:8px;border:1px solid #334155;background:#020617;color:white}
.pagination button.active{background:#2563eb;border-color:#2563eb}
.pagination button:disabled{opacity:.4}
#sidebar.collapsed{width:80px}
#sidebar.collapsed .menu-text{display:none}
#sidebar.collapsed h1{font-size:0}
#sidebar.collapsed h1:after{content:"üè†";font-size:22px}
</style>
</head>

<body class="bg-slate-950 text-white">

<script>
if(sessionStorage.getItem("RUSUN_LOGIN")!=="OK"){
  location.replace("/login.html");
}
</script>

<div class="flex min-h-screen">

<div id="sidebar" class="w-64 bg-slate-900 p-5 flex flex-col transition-all duration-300">
  <h1 class="text-xl font-bold mb-6">RUSUN DASHBOARD</h1>
  <a class="menu-link text-slate-200"><span class="menu-text">Manajemen Penghuni</span></a>
  <a href="/pdam.html" class="menu-link text-blue-400 font-semibold"><span class="menu-text">PDAM</span></a>
  <a href="https://kk-terima-2026.vercel.app/" target="_blank" class="menu-link text-slate-300"><span class="menu-text">KK Sewa 2026</span></a>
  <a href="https://tgk-rusun-2026.vercel.app/" target="_blank" class="menu-link text-slate-300"><span class="menu-text">Tunggakan 2026</span></a>
  <div class="mt-auto">
    <a onclick="logout()" class="text-red-400 cursor-pointer menu-text">Logout</a>
  </div>
</div>

<div class="flex-1 p-8">

<div class="flex items-center gap-4 mb-6">
  <button onclick="toggleSidebar()" class="bg-slate-800 px-3 py-2 rounded-lg hover:bg-slate-700">‚ò∞</button>
  <h2 class="text-2xl font-bold">Dashboard Internal</h2>
</div>

<div class="grid grid-cols-4 gap-4 mb-8">
  <div class="bg-slate-800 p-4 rounded">Penghuni<br><b id="penghuni">-</b></div>
  <div class="bg-slate-800 p-4 rounded">Unit Terisi<br><b id="unitTerisi">-</b></div>
  <div class="bg-slate-800 p-4 rounded">Total Bayar<br><b id="totalBayar">Rp 0</b></div>
  <div class="bg-slate-800 p-4 rounded">Total Tunggakan<br><b id="totalTunggakan">Rp 0</b></div>
</div>

<div class="bg-slate-900 rounded p-5">
<h3 class="font-bold mb-4">Daftar Penghuni</h3>

<div class="flex gap-3 mb-4">
  <input id="searchInput" placeholder="Cari unit / nama..." class="flex-1 p-2 bg-slate-800 rounded">
  <select id="statusFilter" class="p-2 bg-slate-800 rounded">
    <option value="">Semua Status</option>
    <option value="TERISI">Terisi</option>
    <option value="RUSAK">Rusak</option>
    <option value="SIAP">Siap Huni</option>
  </select>
</div>

<table class="w-full text-sm">
<thead class="border-b border-slate-700">
<tr>
<th class="py-2 text-left">Unit</th>
<th class="py-2 text-left">Nama</th>
<th class="py-2 text-left">Status</th>
<th class="py-2 text-left">Total Bayar</th>
<th class="py-2 text-left">Total Tunggakan</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div id="pagination" class="pagination mt-4"></div>
</div>
</div>
</div>

<!-- MODAL DETAIL -->
<div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
<div class="bg-slate-900 max-w-6xl w-full rounded-2xl p-6 overflow-y-auto max-h-[90vh]">

<div class="flex justify-between items-center mb-4">
<h2 id="judulDetail" class="text-xl font-bold">Detail Penghuni</h2>
<button onclick="closeModal()" class="text-red-400 font-bold">‚úñ Tutup</button>
</div>

<div id="detailBox" class="space-y-6"></div>

</div>
</div>

<script>
function toggleSidebar(){ sidebar.classList.toggle("collapsed"); }
function logout(){ sessionStorage.clear(); location.href="/login.html"; }

const penghuni=document.getElementById("penghuni"),
unitTerisi=document.getElementById("unitTerisi"),
totalBayar=document.getElementById("totalBayar"),
totalTunggakan=document.getElementById("totalTunggakan"),
tbody=document.getElementById("tbody"),
searchInput=document.getElementById("searchInput"),
statusFilter=document.getElementById("statusFilter"),
pagination=document.getElementById("pagination"),
modal=document.getElementById("modal"),
detailBox=document.getElementById("detailBox"),
judulDetail=document.getElementById("judulDetail");

let allData=[],filteredData=[],currentPage=1,rowsPerPage=25;

async function loadData(){
  const res=await fetch("/api/data?action=internal&key=rusun2026",{headers:{"X-Requested-With":"XMLHttpRequest"}});
  const json=await res.json();
  const sum=json.data.summary,data=json.data.data;
  penghuni.innerText=sum.penghuni;
  unitTerisi.innerText=sum.terisi;
  totalBayar.innerText="Rp "+Number(sum.totalBayar).toLocaleString("id-ID");
  totalTunggakan.innerText="Rp "+Number(sum.totalTunggakan).toLocaleString("id-ID");
  allData=data;filteredData=data;renderTable();
}

function badgeStatus(status){
  if(!status) return "-";
  const s=status.toLowerCase();
  if(s.includes("terisi")) return `<span class="badge badge-terisi">Terisi</span>`;
  if(s.includes("rusak")) return `<span class="badge badge-rusak">Rusak</span>`;
  if(s.includes("siap")) return `<span class="badge badge-siap">Siap Huni</span>`;
  return status;
}

function applyFilter(){
  const search=searchInput.value.toLowerCase(),status=statusFilter.value;
  filteredData=allData.filter(d=>{
    const unit=(d.unit||"").toLowerCase(),
          nama=(d.nama||"").toLowerCase(),
          st=(d.kondisiunit||"").toUpperCase();
    return (unit.includes(search)||nama.includes(search)) && (!status||st.includes(status));
  });
  currentPage=1;
  renderTable();
}

function renderTable(){
  tbody.innerHTML="";
  const start=(currentPage-1)*rowsPerPage;
  filteredData.slice(start,start+rowsPerPage).forEach(d=>{
    tbody.innerHTML+=`
    <tr class="border-b border-slate-800 hover:bg-slate-800">
      <td class="py-1 uppercase text-blue-400 cursor-pointer font-bold" onclick='openDetail(${JSON.stringify(d)})'>${d.unit}</td>
      <td>${d.nama}</td>
      <td>${badgeStatus(d.kondisiunit)}</td>
      <td>Rp ${Number(d.pembayaran).toLocaleString("id-ID")}</td>
      <td>Rp ${Number(d.tunggakan).toLocaleString("id-ID")}</td>
    </tr>`;
  });
  renderPagination();
}

function renderPagination(){
  pagination.innerHTML="";
  const totalPage=Math.ceil(filteredData.length/rowsPerPage);

  const prev=document.createElement("button");
  prev.textContent="Prev";
  prev.disabled=currentPage===1;
  prev.onclick=()=>{currentPage--;renderTable();};
  pagination.appendChild(prev);

  for(let i=1;i<=totalPage;i++){
    const b=document.createElement("button");
    b.textContent=i;
    if(i===currentPage)b.classList.add("active");
    b.onclick=()=>{currentPage=i;renderTable();};
    pagination.appendChild(b);
  }

  const next=document.createElement("button");
  next.textContent="Next";
  next.disabled=currentPage===totalPage;
  next.onclick=()=>{currentPage++;renderTable();};
  pagination.appendChild(next);
}

function section(title,content){
  return `<div class="bg-slate-800/60 p-4 rounded-xl">
    <h3 class="font-bold text-blue-400 mb-3">${title}</h3>${content}</div>`;
}

function gridRow(label,val){
  return `<div class="text-slate-400">${label}</div><div class="font-semibold">${val||"-"}</div>`;
}

function anggotaCard(title,o){
  if(!o.nama) return "";
  return `<div class="bg-slate-800 p-4 rounded-xl">
    <h4 class="font-bold text-blue-400 mb-2">${title}</h4>
    <div class="grid grid-cols-2 gap-2 text-sm">
      ${gridRow("Nama",o.nama)}
      ${gridRow("NIK",o.nik)}
      ${gridRow("Jenis Kelamin",o.jk)}
      ${gridRow("TTL",fmtTanggal(o.ttl))}
      ${gridRow("Umur",o.umur)}
      ${gridRow("Status",o.status)}
      ${gridRow("Disabilitas",o.disabilitas)}
    </div></div>`;
}

function fmtTanggal(val){
  if(!val) return "-";
  const d=new Date(val);
  if(isNaN(d)) return val;
  return d.toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"});
}

function kontrakBadge(val){
  if(!val) return "";
  const end=new Date(val);
  if(isNaN(end)) return "";
  const now=new Date();
  const diff=Math.ceil((end-now)/(1000*60*60*24));
  if(diff<0) return '<span class="badge badge-rusak ml-2">HABIS</span>';
  if(diff<=30) return '<span class="badge badge-siap ml-2">AKAN HABIS ('+diff+' hari)</span>';
  return "";
}

/* ===== TAMBAHAN BARU: RIWAYAT PERJANJIAN ===== */
function renderRiwayatPerjanjian(list){
  if(!Array.isArray(list)||list.length===0){
    return `<div class="text-slate-400 text-sm italic">Belum ada data perjanjian</div>`;
  }
  const head=Object.keys(list[0]);
  let th=head.map(h=>`<th class="px-3 py-2 text-left">${h}</th>`).join("");
  let rows=list.map(o=>{
    return `<tr class="border-b border-slate-700/50">`+
      head.map(h=>{
        let v=o[h];
        if(String(h).toLowerCase().includes("tgl")) v=fmtTanggal(v);
        if(String(h).toLowerCase()==="status"){
          const s=String(v).toUpperCase();
          let c="bg-slate-700";
          if(s==="AKTIF") c="bg-green-600/20 text-green-400";
          if(s==="NONAKTIF") c="bg-slate-600/20 text-slate-300";
          if(s==="HABIS") c="bg-red-600/20 text-red-400";
          return `<td class="px-3 py-2"><span class="px-2 py-1 rounded ${c}">${v}</span></td>`;
        }
        return `<td class="px-3 py-2">${v||"-"}</td>`;
      }).join("")+
    `</tr>`;
  }).join("");
  return `<div class="overflow-auto">
    <table class="w-full text-sm">
      <thead class="sticky top-0 bg-slate-800"><tr>${th}</tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;
}

function openDetail(d){
  judulDetail.innerText="Detail Penghuni - Unit "+d.unit;

  detailBox.innerHTML=
  section("IDENTITAS PENGHUNI",`
    <div class="grid grid-cols-2 gap-2 text-sm">
      ${gridRow("Nama",d.nama)}
      ${gridRow("NIK",d.nik)}
      ${gridRow("TTL",fmtTanggal(d.ttl))}
      ${gridRow("Agama",d.agama)}
      ${gridRow("Status Perkawinan",d.statusPerkawinan)}
    </div>
  `)+
  section("KONTAK & DOMISILI",`
    <div class="grid grid-cols-2 gap-2 text-sm">
      ${gridRow("Alamat",d.alamat)}
      ${gridRow("No HP", d.telp || d.notelp || d.nohp || d.hp || d["nomor telp"] || d["nomor telp./hp"] || d["no telp"] || "-")}
      ${gridRow("Email",d.email)}
      ${gridRow("Status Tinggal",d.statusTempatTinggal)}
    </div>
  `)+
  section("PEKERJAAN & PENGHASILAN",`
    <div class="grid grid-cols-2 gap-2 text-sm">
      ${gridRow("Pekerjaan",d.pekerjaan)}
      ${gridRow("Penghasilan",d.penghasilan)}
      ${gridRow("Pekerjaan Pasangan",d.pekerjaanPasangan)}
      ${gridRow("Penghasilan Pasangan",d.penghasilanPasangan)}
      ${gridRow("Total Penghasilan",d.totalPenghasilan)}
    </div>
  `)+
  section("DATA ADMINISTRASI",`
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">

      <div class="bg-slate-800 p-4 rounded-xl order-4 md:order-1">
        <h4 class="font-bold text-blue-400 mb-3">Pendaftaran</h4>
        <div class="grid grid-cols-2 gap-2">
          ${gridRow("No Daftar Formulir",d.no_daftar_formulir)}
          ${gridRow("Tanggal Daftar",fmtTanggal(d.tgl_daftar))}
        </div>
      </div>

      <div class="bg-slate-800 p-4 rounded-xl order-3 md:order-2">
        <h4 class="font-bold text-blue-400 mb-3">Pengumuman</h4>
        <div class="grid grid-cols-2 gap-2">
          ${gridRow("No Persetujuan",d.no_setuju_calon_penghuni)}
          ${gridRow("Tanggal Persetujuan",fmtTanggal(d.tgl_setuju_calon_penghuni))}
          ${gridRow("No Panggilan",d.no_panggilan_calon_penghuni)}
          ${gridRow("Tanggal Panggilan",fmtTanggal(d.tgl_panggilan_calon_penghuni))}
        </div>
      </div>

      <div class="bg-slate-800 p-4 rounded-xl order-2 md:order-3">
        <h4 class="font-bold text-blue-400 mb-3">Penetapan</h4>
        <div class="grid grid-cols-2 gap-2">
          ${gridRow("No Penetapan",d.no_penetapan_calon_penghuni)}
          ${gridRow("Tanggal Penetapan",fmtTanggal(d.tgl_penetapan_calon_penghuni))}
        </div>
      </div>

      <div class="bg-slate-800 p-4 rounded-xl order-1 md:order-4">
        <h4 class="font-bold text-blue-400 mb-3">Perjanjian</h4>
        <div class="grid grid-cols-2 gap-2">
          ${gridRow("No Perjanjian",d.no_perjanjian_penghuni)}
          ${gridRow("Tanggal Mulai",fmtTanggal(d.tgl_perjanjian_mulai_penghuni))}
          <div class="text-slate-400">Tanggal Akhir</div>
          <div class="font-semibold">
            ${fmtTanggal(d.tgl_perjanjian_akhir_penghuni)}
            ${kontrakBadge(d.tgl_perjanjian_akhir_penghuni)}
          </div>
        </div>
      </div>

    </div>
  `)+
  section("RIWAYAT PERJANJIAN",`
    ${renderRiwayatPerjanjian(d.riwayatPerjanjian)}
  `)+
  section("ANGGOTA KELUARGA",`
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      ${anggotaCard("Anggota 1",{nama:d.anggota1,nik:d.nik1,jk:d.jk1,ttl:d.ttl1,umur:d.umur1,status:d.status1,disabilitas:d.disabilitas1})}
      ${anggotaCard("Anggota 2",{nama:d.anggota2,nik:d.nik2,jk:d.jk2,ttl:d.ttl2,umur:d.umur2,status:d.status2,disabilitas:d.disabilitas2})}
      ${anggotaCard("Anggota 3",{nama:d.anggota3,nik:d.nik3,jk:d.jk3,ttl:d.ttl3,umur:d.umur3,status:d.status3,disabilitas:d.disabilitas3})}
      ${anggotaCard("Anggota 4",{nama:d.anggota4,nik:d.nik4,jk:d.jk4,ttl:d.ttl4,umur:d.umur4,status:d.status4,disabilitas:d.disabilitas4})}
    </div>
  `)+
  section("DATA PENJAMIN",`
    <div class="grid grid-cols-2 gap-2 text-sm">
      ${gridRow("Nama",d.penjamin)}
      ${gridRow("NIK",d.nikPenjamin)}
      ${gridRow("Alamat",d.alamatPenjamin)}
      ${gridRow("No HP",d.telpPenjamin)}
      ${gridRow("Status",d.statusPenjamin)}
    </div>
  `)+
  section("STATUS KEUANGAN",`
    <div class="grid grid-cols-2 gap-2 text-sm">
      ${gridRow("Total Bayar","Rp "+Number(d.pembayaran).toLocaleString("id-ID"))}
      ${gridRow("Tunggakan","Rp "+Number(d.tunggakan).toLocaleString("id-ID"))}
    </div>
  `)+
  section("STATUS UNIT",`
    <div class="grid grid-cols-2 gap-2 text-sm">
      ${gridRow("Kondisi Unit",d.kondisiunit)}
    </div>
  `);

  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

function closeModal(){
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

searchInput.addEventListener("input",applyFilter);
statusFilter.addEventListener("change",applyFilter);

loadData();
</script>
</body>
</html>
