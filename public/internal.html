<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Dashboard Internal Rusun</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
.badge-terisi{background:rgba(34,197,94,.15);color:#22c55e;border:1px solid rgba(34,197,94,.4)}
.badge-rusak{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.4)}
.badge-siap{background:rgba(234,179,8,.15);color:#eab308;border:1px solid rgba(234,179,8,.4)}
.menu-link{display:block;padding:8px 10px;border-radius:8px}
.menu-link:hover{background:#020617}
.pagination button{padding:6px 12px;margin:0 2px;border-radius:8px;border:1px solid #334155;background:#020617;color:white}
.pagination button.active{background:#2563eb;border-color:#2563eb}
.pagination button:disabled{opacity:.4}
#sidebar.collapsed{width:80px}
#sidebar.collapsed .menu-text{display:none}
#sidebar.collapsed h1{font-size:0}
#sidebar.collapsed h1:after{content:"üè†";font-size:22px}
</style>
</head>

<body class="bg-slate-950 text-white">

<script>
if(sessionStorage.getItem("RUSUN_LOGIN")!=="OK"){
  location.replace("/login.html");
}
</script>

<div class="flex min-h-screen">

<div id="sidebar" class="w-64 bg-slate-900 p-5 flex flex-col transition-all duration-300">
  <h1 class="text-xl font-bold mb-6">RUSUN DASHBOARD</h1>

  <a class="menu-link text-slate-200"><span class="menu-text">Manajemen Penghuni</span></a>
  <a href="https://kk-terima-2026.vercel.app/" target="_blank" class="menu-link text-slate-300"><span class="menu-text">KK Sewa 2026</span></a>
  <a href="https://tgk-rusun-2026.vercel.app/" target="_blank" class="menu-link text-slate-300"><span class="menu-text">Tunggakan 2026</span></a>

  <div class="mt-auto">
    <a onclick="logout()" class="text-red-400 cursor-pointer menu-text">Logout</a>
  </div>
</div>

<div class="flex-1 p-8">

<div class="flex items-center gap-4 mb-6">
  <button onclick="toggleSidebar()" class="bg-slate-800 px-3 py-2 rounded-lg hover:bg-slate-700">‚ò∞</button>
  <h2 class="text-2xl font-bold">Dashboard Internal</h2>
</div>

<div class="grid grid-cols-4 gap-4 mb-8">
  <div class="bg-slate-800 p-4 rounded">Penghuni<br><b id="penghuni">-</b></div>
  <div class="bg-slate-800 p-4 rounded">Unit Terisi<br><b id="unitTerisi">-</b></div>
  <div class="bg-slate-800 p-4 rounded">Total Bayar<br><b id="totalBayar">Rp 0</b></div>
  <div class="bg-slate-800 p-4 rounded">Total Tunggakan<br><b id="totalTunggakan">Rp 0</b></div>
</div>

<div class="bg-slate-900 rounded p-5">
<h3 class="font-bold mb-4">Daftar Penghuni</h3>

<div class="flex gap-3 mb-4">
  <input id="searchInput" placeholder="Cari unit / nama..." class="flex-1 p-2 bg-slate-800 rounded">
  <select id="statusFilter" class="p-2 bg-slate-800 rounded">
    <option value="">Semua Status</option>
    <option value="TERISI">Terisi</option>
    <option value="RUSAK">Rusak</option>
    <option value="SIAP">Siap Huni</option>
  </select>
</div>

<table class="w-full text-sm">
<thead class="border-b border-slate-700">
<tr>
<th class="py-2 text-left">Unit</th>
<th class="py-2 text-left">Nama</th>
<th class="py-2 text-left">Status</th>
<th class="py-2 text-left">Total Bayar</th>
<th class="py-2 text-left">Total Tunggakan</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div id="pagination" class="pagination mt-4"></div>
</div>
</div>
</div>

<!-- MODAL DETAIL -->
<div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
<div class="bg-slate-900 max-w-5xl w-full rounded-2xl p-6 overflow-y-auto max-h-[90vh]">

<div class="flex justify-between items-center mb-4">
<h2 id="judulDetail" class="text-xl font-bold">Detail Penghuni</h2>
<button onclick="closeModal()" class="text-red-400 font-bold">‚úñ Tutup</button>
</div>

<div id="detailBox" class="space-y-6"></div>

</div>
</div>

<script>
function toggleSidebar(){ sidebar.classList.toggle("collapsed"); }
function logout(){ sessionStorage.clear(); location.href="/login.html"; }

const penghuni=document.getElementById("penghuni"),
unitTerisi=document.getElementById("unitTerisi"),
totalBayar=document.getElementById("totalBayar"),
totalTunggakan=document.getElementById("totalTunggakan"),
tbody=document.getElementById("tbody"),
searchInput=document.getElementById("searchInput"),
statusFilter=document.getElementById("statusFilter"),
pagination=document.getElementById("pagination"),
modal=document.getElementById("modal"),
detailBox=document.getElementById("detailBox"),
judulDetail=document.getElementById("judulDetail");

let allData=[],filteredData=[],currentPage=1,rowsPerPage=25;

async function loadData(){
  const res=await fetch("/api/data?action=internal&key=rusun2026",{headers:{"X-Requested-With":"XMLHttpRequest"}});
  const json=await res.json();
  const sum=json.data.summary,data=json.data.data;
  penghuni.innerText=sum.penghuni;
  unitTerisi.innerText=sum.terisi;
  totalBayar.innerText="Rp "+Number(sum.totalBayar).toLocaleString("id-ID");
  totalTunggakan.innerText="Rp "+Number(sum.totalTunggakan).toLocaleString("id-ID");
  allData=data;filteredData=data;renderTable();
}

function badgeStatus(status){
  if(!status) return "-";
  const s=status.toLowerCase();
  if(s.includes("terisi")) return `<span class="badge badge-terisi">Terisi</span>`;
  if(s.includes("rusak")) return `<span class="badge badge-rusak">Rusak</span>`;
  if(s.includes("siap")) return `<span class="badge badge-siap">Siap Huni</span>`;
  return status;
}

function renderTable(){
  tbody.innerHTML="";
  const start=(currentPage-1)*rowsPerPage;
  filteredData.slice(start,start+rowsPerPage).forEach(d=>{
    tbody.innerHTML+=`
    <tr class="border-b border-slate-800 hover:bg-slate-800">
      <td class="py-1 uppercase text-blue-400 cursor-pointer font-bold" onclick='openDetail(${JSON.stringify(d)})'>${d.unit||""}</td>
      <td>${d.nama||""}</td>
      <td>${badgeStatus(d.kondisiunit)}</td>
      <td>Rp ${Number(d.pembayaran||0).toLocaleString("id-ID")}</td>
      <td>Rp ${Number(d.tunggakan||0).toLocaleString("id-ID")}</td>
    </tr>`;
  });
}

function section(title, rows){
  return `
  <div class="bg-slate-800/60 p-4 rounded-xl">
    <h3 class="font-bold text-blue-400 mb-3">${title}</h3>
    <div class="grid grid-cols-2 gap-2 text-sm">${rows}</div>
  </div>`;
}

function row(label,val){
  return `<div class="text-slate-400">${label}</div><div class="font-semibold">${val||"-"}</div>`;
}

function openDetail(d){
  judulDetail.innerText="Detail Penghuni - Unit "+d.unit.toUpperCase();
  detailBox.innerHTML="";

  detailBox.innerHTML+=section("IDENTITAS PENGHUNI",
    row("Nama",d.nama)+row("NIK",d.nik)+row("TTL",d.ttl)+row("Agama",d.agama)+row("Status Kawin",d.statusPerkawinan)
  );

  detailBox.innerHTML+=section("KONTAK & DOMISILI",
    row("Alamat",d.alamat)+row("No. HP",d.telp)+row("Email",d.email)+row("Status Tinggal",d.statusTempatTinggal)
  );

  detailBox.innerHTML+=section("PEKERJAAN & PENGHASILAN",
    row("Pekerjaan",d.pekerjaan)+row("Penghasilan",d.penghasilan)+
    row("Pekerjaan Pasangan",d.pekerjaanPasangan)+row("Penghasilan Pasangan",d.penghasilanPasangan)+
    row("Total Penghasilan",d.totalPenghasilan)
  );

  detailBox.innerHTML+=section("ANGGOTA KELUARGA",
    row("Anggota 1",d.anggota1)+"<div></div>"+
    row("Anggota 2",d.anggota2)+"<div></div>"+
    row("Anggota 3",d.anggota3)+"<div></div>"+
    row("Anggota 4",d.anggota4)
  );

  detailBox.innerHTML+=section("DATA PENJAMIN",
    row("Nama",d.penjamin)+row("NIK",d.nikPenjamin)+row("Alamat",d.alamatPenjamin)+row("No. HP",d.telpPenjamin)
  );

  detailBox.innerHTML+=section("STATUS UNIT & KEUANGAN",
    row("Kondisi Unit",d.kondisiunit)+row("Total Bayar","Rp "+Number(d.pembayaran).toLocaleString("id-ID"))+
    row("Tunggakan","Rp "+Number(d.tunggakan).toLocaleString("id-ID"))
  );

  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

function closeModal(){ modal.classList.add("hidden"); modal.classList.remove("flex"); }

loadData();
</script>
</body>
</html>
